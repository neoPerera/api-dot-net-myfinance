name: CI - Build and Push Docker Images

on:
  push:
    tags: [ 'v*' ]   # â¬…ï¸ triggers on version tags like v1.0.0
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”„ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ðŸ·ï¸ Set image tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"     # Use the Git tag as Docker tag
          else
            BRANCH_NAME=$(echo "${GITHUB_REF#refs/heads/}" | tr '/' '-')
            if [ "$BRANCH_NAME" = "master" ]; then
              IMAGE_TAG="latest"
            else
              IMAGE_TAG="$BRANCH_NAME"
            fi
          fi
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: ðŸ“¦ Build MainService Docker image
        run: |
          docker build -f MainService.API/Dockerfile -t chanuth/api-dot-net-myfinance:main.${IMAGE_TAG} .

      - name: ðŸ“¦ Build MyFinanceService Docker image
        run: |
          docker build -f MyFinanceService.API/Dockerfile -t chanuth/api-dot-net-myfinance:myfinance.${IMAGE_TAG} .
      - name: ðŸ“¦ Build CommonLogWorker Docker image
        run: |
          docker build -f CommonLogWorker/Dockerfile -t chanuth/api-dot-net-myfinance:commonLogWorker.${IMAGE_TAG} .

      - name: ðŸ“¤ Push MainService Docker image
        run: |
          docker push chanuth/api-dot-net-myfinance:main.${IMAGE_TAG}

      - name: ðŸ“¤ Push MyFinanceService Docker image
        run: |
          docker push chanuth/api-dot-net-myfinance:myfinance.${IMAGE_TAG}
          
      - name: ðŸ“¤ Push CommonLogWorker Docker image
        run: |
          docker push chanuth/api-dot-net-myfinance:commonLogWorker.${IMAGE_TAG}

